# é‡æ„å®æ–½è®¡åˆ’

## ğŸ“… æ€»ä½“æ—¶é—´è§„åˆ’

### é¡¹ç›®å‘¨æœŸï¼š4-6å‘¨
- **ç¬¬ä¸€é˜¶æ®µ**ï¼šåŸºç¡€é‡æ„ï¼ˆ1-2å‘¨ï¼‰
- **ç¬¬äºŒé˜¶æ®µ**ï¼šæ ¸å¿ƒé‡æ„ï¼ˆ2-3å‘¨ï¼‰
- **ç¬¬ä¸‰é˜¶æ®µ**ï¼šä¼˜åŒ–å®Œå–„ï¼ˆ1-2å‘¨ï¼‰

## ğŸ¯ ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€é‡æ„ï¼ˆ1-2å‘¨ï¼‰

### ç›®æ ‡
- ä»£ç å¤‡ä»½å’Œç›®å½•æ•´ç†
- ç»Ÿä¸€é…ç½®ç®¡ç†
- åŸºç¡€çŠ¶æ€ç®¡ç†é‡æ„

### ä»»åŠ¡æ¸…å•

#### ç¬¬1å‘¨ï¼šä»£ç å¤‡ä»½å’Œç›®å½•æ•´ç†

**Day 1-2ï¼šä»£ç å¤‡ä»½**
- [ ] åˆ›å»ºbackupç›®å½•ç»“æ„
- [ ] å¤‡ä»½æ‰€æœ‰ç°æœ‰ä»£ç æ–‡ä»¶
- [ ] åˆ›å»ºå¤‡ä»½æ¸…å•å’Œç‰ˆæœ¬è®°å½•
- [ ] éªŒè¯å¤‡ä»½å®Œæ•´æ€§

**Day 3-4ï¼šç›®å½•æ•´ç†**
- [ ] æ•´ç†ç°æœ‰ä»£ç ç›®å½•ç»“æ„
- [ ] åˆ›å»ºæ–°çš„ç›®å½•ç»“æ„
- [ ] ç§»åŠ¨æ–‡ä»¶åˆ°æ–°ç›®å½•
- [ ] æ›´æ–°importè·¯å¾„

**Day 5ï¼šé…ç½®ç®¡ç†é‡æ„**
- [ ] åˆ›å»ºç»Ÿä¸€config.py
- [ ] åˆ›å»ºç»Ÿä¸€config.js
- [ ] è¿ç§»ç°æœ‰é…ç½®
- [ ] æµ‹è¯•é…ç½®åŠ è½½

#### ç¬¬2å‘¨ï¼šåŸºç¡€çŠ¶æ€ç®¡ç†é‡æ„

**Day 1-2ï¼šçŠ¶æ€ç®¡ç†å™¨è®¾è®¡**
- [ ] è®¾è®¡æ–°çš„çŠ¶æ€ç®¡ç†å™¨
- [ ] å®ç°åŸºç¡€çŠ¶æ€ç®¡ç†åŠŸèƒ½
- [ ] åˆ›å»ºçŠ¶æ€è½¬æ¢è§„åˆ™
- [ ] ç¼–å†™çŠ¶æ€ç®¡ç†æµ‹è¯•

**Day 3-4ï¼šäº‹ä»¶ç®¡ç†å™¨è®¾è®¡**
- [ ] è®¾è®¡äº‹ä»¶ç®¡ç†å™¨
- [ ] å®ç°äº‹ä»¶å¤„ç†æœºåˆ¶
- [ ] åˆ›å»ºäº‹ä»¶å¤„ç†å™¨
- [ ] ç¼–å†™äº‹ä»¶å¤„ç†æµ‹è¯•

**Day 5ï¼šåŸºç¡€é›†æˆæµ‹è¯•**
- [ ] é›†æˆçŠ¶æ€ç®¡ç†å’Œäº‹ä»¶ç®¡ç†
- [ ] æµ‹è¯•åŸºç¡€åŠŸèƒ½
- [ ] ä¿®å¤å‘ç°çš„é—®é¢˜
- [ ] ç¼–å†™é›†æˆæµ‹è¯•

### äº¤ä»˜ç‰©
- [ ] å®Œæ•´çš„ä»£ç å¤‡ä»½
- [ ] æ–°çš„ç›®å½•ç»“æ„
- [ ] ç»Ÿä¸€çš„é…ç½®æ–‡ä»¶
- [ ] åŸºç¡€çŠ¶æ€ç®¡ç†å™¨
- [ ] åŸºç¡€äº‹ä»¶ç®¡ç†å™¨

## ğŸ”§ ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒé‡æ„ï¼ˆ2-3å‘¨ï¼‰

### ç›®æ ‡
- çŠ¶æ€ç®¡ç†å®Œå…¨é‡æ„
- äº‹ä»¶é©±åŠ¨æ¶æ„å®ç°
- WebSocketè¿æ¥ç®¡ç†ä¼˜åŒ–

### ä»»åŠ¡æ¸…å•

#### ç¬¬3å‘¨ï¼šçŠ¶æ€ç®¡ç†å®Œå…¨é‡æ„

**Day 1-2ï¼šçŠ¶æ€ç®¡ç†é‡æ„**
- [ ] å®ç°8ä¸ªæ¸…æ™°çŠ¶æ€
- [ ] å®ç°çŠ¶æ€è½¬æ¢è§„åˆ™
- [ ] å®ç°çŠ¶æ€é”å®šæœºåˆ¶
- [ ] å®ç°çŠ¶æ€å›æ»šåŠŸèƒ½

**Day 3-4ï¼šäº‹ä»¶é©±åŠ¨æ¶æ„**
- [ ] å®ç°äº‹ä»¶åˆ†ç»„
- [ ] å®ç°äº‹ä»¶å¤„ç†å™¨
- [ ] å®ç°äº‹ä»¶ä¼˜å…ˆçº§
- [ ] å®ç°äº‹ä»¶é˜Ÿåˆ—ç®¡ç†

**Day 5ï¼šçŠ¶æ€ç®¡ç†é›†æˆ**
- [ ] é›†æˆçŠ¶æ€ç®¡ç†å’Œäº‹ä»¶ç®¡ç†
- [ ] æµ‹è¯•çŠ¶æ€è½¬æ¢
- [ ] æµ‹è¯•äº‹ä»¶å¤„ç†
- [ ] ä¿®å¤å‘ç°çš„é—®é¢˜

#### ç¬¬4å‘¨ï¼šWebSocketè¿æ¥ç®¡ç†ä¼˜åŒ–

**Day 1-2ï¼šWebSocketç®¡ç†å™¨é‡æ„**
- [ ] å®ç°WebSocketç®¡ç†å™¨
- [ ] å®ç°è‡ªåŠ¨é‡è¿æœºåˆ¶
- [ ] å®ç°å¿ƒè·³æ£€æµ‹
- [ ] å®ç°è¿æ¥æ± ç®¡ç†

**Day 3-4ï¼šWebSocketé›†æˆ**
- [ ] é›†æˆWebSocketç®¡ç†å™¨
- [ ] æµ‹è¯•è¿æ¥ç¨³å®šæ€§
- [ ] æµ‹è¯•é‡è¿æœºåˆ¶
- [ ] æµ‹è¯•å¿ƒè·³æ£€æµ‹

**Day 5ï¼šWebSocketä¼˜åŒ–**
- [ ] ä¼˜åŒ–è¿æ¥æ€§èƒ½
- [ ] ä¼˜åŒ–é‡è¿ç­–ç•¥
- [ ] ä¼˜åŒ–é”™è¯¯å¤„ç†
- [ ] ç¼–å†™WebSocketæµ‹è¯•

#### ç¬¬5å‘¨ï¼šæ™ºèƒ½è¶…æ—¶æœºåˆ¶

**Day 1-2ï¼šè¶…æ—¶æœºåˆ¶è®¾è®¡**
- [ ] å®ç°åŠ¨æ€è¶…æ—¶è®¡ç®—
- [ ] å®ç°è¶…æ—¶å¤„ç†é€»è¾‘
- [ ] å®ç°è¶…æ—¶è­¦å‘Šæœºåˆ¶
- [ ] å®ç°è¶…æ—¶æ¢å¤æœºåˆ¶

**Day 3-4ï¼šè¶…æ—¶æœºåˆ¶é›†æˆ**
- [ ] é›†æˆè¶…æ—¶æœºåˆ¶
- [ ] æµ‹è¯•çŸ­æ–‡æœ¬å¤„ç†
- [ ] æµ‹è¯•é•¿æ–‡æœ¬å¤„ç†
- [ ] æµ‹è¯•è¶…æ—¶å¤„ç†

**Day 5ï¼šè¶…æ—¶æœºåˆ¶ä¼˜åŒ–**
- [ ] ä¼˜åŒ–è¶…æ—¶ç­–ç•¥
- [ ] ä¼˜åŒ–è¶…æ—¶æç¤º
- [ ] ä¼˜åŒ–è¶…æ—¶æ¢å¤
- [ ] ç¼–å†™è¶…æ—¶æµ‹è¯•

### äº¤ä»˜ç‰©
- [ ] å®Œæ•´çš„çŠ¶æ€ç®¡ç†ç³»ç»Ÿ
- [ ] å®Œæ•´çš„äº‹ä»¶é©±åŠ¨æ¶æ„
- [ ] ä¼˜åŒ–çš„WebSocketç®¡ç†å™¨
- [ ] æ™ºèƒ½è¶…æ—¶æœºåˆ¶
- [ ] å®Œæ•´çš„é›†æˆæµ‹è¯•

## ğŸš€ ç¬¬ä¸‰é˜¶æ®µï¼šä¼˜åŒ–å®Œå–„ï¼ˆ1-2å‘¨ï¼‰

### ç›®æ ‡
- é”™è¯¯å¤„ç†ç»Ÿä¸€åŒ–
- æ€§èƒ½ä¼˜åŒ–
- æµ‹è¯•å’ŒéªŒè¯

### ä»»åŠ¡æ¸…å•

#### ç¬¬6å‘¨ï¼šé”™è¯¯å¤„ç†ç»Ÿä¸€åŒ–

**Day 1-2ï¼šé”™è¯¯å¤„ç†ç³»ç»Ÿ**
- [ ] å®ç°ç»Ÿä¸€é”™è¯¯å¤„ç†å™¨
- [ ] å®ç°é”™è¯¯åˆ†ç±»
- [ ] å®ç°é”™è¯¯æ¢å¤æœºåˆ¶
- [ ] å®ç°ç”¨æˆ·å‹å¥½æç¤º

**Day 3-4ï¼šé”™è¯¯å¤„ç†é›†æˆ**
- [ ] é›†æˆé”™è¯¯å¤„ç†ç³»ç»Ÿ
- [ ] æµ‹è¯•é”™è¯¯å¤„ç†
- [ ] æµ‹è¯•é”™è¯¯æ¢å¤
- [ ] æµ‹è¯•ç”¨æˆ·æç¤º

**Day 5ï¼šé”™è¯¯å¤„ç†ä¼˜åŒ–**
- [ ] ä¼˜åŒ–é”™è¯¯å¤„ç†é€»è¾‘
- [ ] ä¼˜åŒ–é”™è¯¯æç¤º
- [ ] ä¼˜åŒ–é”™è¯¯æ¢å¤
- [ ] ç¼–å†™é”™è¯¯å¤„ç†æµ‹è¯•

#### ç¬¬7å‘¨ï¼šæ€§èƒ½ä¼˜åŒ–å’Œæµ‹è¯•

**Day 1-2ï¼šæ€§èƒ½ä¼˜åŒ–**
- [ ] ä¼˜åŒ–èµ„æºç®¡ç†
- [ ] ä¼˜åŒ–å†…å­˜ä½¿ç”¨
- [ ] ä¼˜åŒ–å“åº”é€Ÿåº¦
- [ ] ä¼˜åŒ–å¹¶å‘å¤„ç†

**Day 3-4ï¼šå…¨é¢æµ‹è¯•**
- [ ] åŠŸèƒ½æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] ç¨³å®šæ€§æµ‹è¯•
- [ ] å…¼å®¹æ€§æµ‹è¯•

**Day 5ï¼šæ–‡æ¡£å’Œéƒ¨ç½²**
- [ ] ç¼–å†™æŠ€æœ¯æ–‡æ¡£
- [ ] ç¼–å†™ç”¨æˆ·æ‰‹å†Œ
- [ ] å‡†å¤‡éƒ¨ç½²æ–¹æ¡ˆ
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆ

### äº¤ä»˜ç‰©
- [ ] ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ç³»ç»Ÿ
- [ ] æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š
- [ ] å®Œæ•´çš„æµ‹è¯•æŠ¥å‘Š
- [ ] æŠ€æœ¯æ–‡æ¡£
- [ ] éƒ¨ç½²æ–¹æ¡ˆ

## ğŸ“‹ è¯¦ç»†å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šä»£ç å¤‡ä»½å’Œç›®å½•æ•´ç†

#### 1.1 åˆ›å»ºå¤‡ä»½ç›®å½•ç»“æ„
```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p /Users/zhangjun/PycharmProjects/yyAsistant/backup/$(date +%Y%m%d_%H%M%S)

# å¤‡ä»½ç°æœ‰ä»£ç 
cp -r /Users/zhangjun/PycharmProjects/yyAsistant/* /Users/zhangjun/PycharmProjects/yyAsistant/backup/$(date +%Y%m%d_%H%M%S)/

# åˆ›å»ºå¤‡ä»½æ¸…å•
find /Users/zhangjun/PycharmProjects/yyAsistant -name "*.py" -o -name "*.js" -o -name "*.json" | wc -l > backup_count.txt
```

#### 1.2 æ•´ç†ç›®å½•ç»“æ„
```bash
# åˆ›å»ºæ–°ç›®å½•ç»“æ„
mkdir -p core/{state_manager,event_manager,config_manager,error_handler,websocket_manager}
mkdir -p config
mkdir -p tests/{unit,integration,e2e}
mkdir -p docs/{api,user,developer}
```

#### 1.3 ç§»åŠ¨æ–‡ä»¶åˆ°æ–°ç›®å½•
```bash
# ç§»åŠ¨æ ¸å¿ƒæ–‡ä»¶
mv app.py core/
mv callbacks/ core/
mv utils/ core/

# ç§»åŠ¨é…ç½®æ–‡ä»¶
mv configs/* config/
rmdir configs/
```

### æ­¥éª¤2ï¼šé…ç½®ç®¡ç†é‡æ„

#### 2.1 åˆ›å»ºç»Ÿä¸€config.py
```python
# config/config.py
import os
from typing import Dict, Any

class Config:
    """ç»Ÿä¸€é…ç½®ç®¡ç†"""
    
    def __init__(self):
        self.config = {
            # åº”ç”¨é…ç½®
            'app': {
                'name': 'yyAsistant',
                'version': '2.0.0',
                'debug': os.getenv('DEBUG', 'False').lower() == 'true'
            },
            
            # æ•°æ®åº“é…ç½®
            'database': {
                'url': os.getenv('DATABASE_URL', 'sqlite:///yyAsistant.db'),
                'pool_size': int(os.getenv('DB_POOL_SIZE', '10')),
                'max_overflow': int(os.getenv('DB_MAX_OVERFLOW', '20'))
            },
            
            # WebSocketé…ç½®
            'websocket': {
                'url': os.getenv('WEBSOCKET_URL', 'ws://localhost:8000/ws'),
                'reconnect_attempts': int(os.getenv('WS_RECONNECT_ATTEMPTS', '5')),
                'reconnect_interval': int(os.getenv('WS_RECONNECT_INTERVAL', '5000')),
                'heartbeat_interval': int(os.getenv('WS_HEARTBEAT_INTERVAL', '30000'))
            },
            
            # è¯­éŸ³é…ç½®
            'voice': {
                'synthesis_voice': os.getenv('VOICE_SYNTHESIS_VOICE', 'zh-CN-XiaoxiaoNeural'),
                'synthesis_speed': float(os.getenv('VOICE_SYNTHESIS_SPEED', '1.0')),
                'synthesis_volume': float(os.getenv('VOICE_SYNTHESIS_VOLUME', '1.0')),
                'recognition_language': os.getenv('VOICE_RECOGNITION_LANGUAGE', 'zh-CN')
            },
            
            # è¶…æ—¶é…ç½®
            'timeouts': {
                'sse_base': int(os.getenv('SSE_TIMEOUT_BASE', '30')),
                'sse_per_char': float(os.getenv('SSE_TIMEOUT_PER_CHAR', '0.1')),
                'sse_max': int(os.getenv('SSE_TIMEOUT_MAX', '300')),
                'tts_base': int(os.getenv('TTS_TIMEOUT_BASE', '60')),
                'tts_per_char': float(os.getenv('TTS_TIMEOUT_PER_CHAR', '0.2')),
                'tts_max': int(os.getenv('TTS_TIMEOUT_MAX', '600')),
                'stt_base': int(os.getenv('STT_TIMEOUT_BASE', '30')),
                'stt_per_char': float(os.getenv('STT_TIMEOUT_PER_CHAR', '0.05')),
                'stt_max': int(os.getenv('STT_TIMEOUT_MAX', '180'))
            }
        }
    
    def get(self, key: str, default: Any = None) -> Any:
        """è·å–é…ç½®å€¼"""
        keys = key.split('.')
        value = self.config
        for k in keys:
            if isinstance(value, dict) and k in value:
                value = value[k]
            else:
                return default
        return value
    
    def set(self, key: str, value: Any) -> None:
        """è®¾ç½®é…ç½®å€¼"""
        keys = key.split('.')
        config = self.config
        for k in keys[:-1]:
            if k not in config:
                config[k] = {}
            config = config[k]
        config[keys[-1]] = value

# å…¨å±€é…ç½®å®ä¾‹
config = Config()
```

#### 2.2 åˆ›å»ºç»Ÿä¸€config.js
```javascript
// config/config.js
class Config {
    constructor() {
        this.config = {
            // åº”ç”¨é…ç½®
            app: {
                name: 'yyAsistant',
                version: '2.0.0',
                debug: window.location.hostname === 'localhost'
            },
            
            // WebSocketé…ç½®
            websocket: {
                url: this.getWebSocketUrl(),
                reconnectAttempts: 5,
                reconnectInterval: 5000,
                heartbeatInterval: 30000
            },
            
            // è¯­éŸ³é…ç½®
            voice: {
                synthesisVoice: 'zh-CN-XiaoxiaoNeural',
                synthesisSpeed: 1.0,
                synthesisVolume: 1.0,
                recognitionLanguage: 'zh-CN'
            },
            
            // è¶…æ—¶é…ç½®
            timeouts: {
                sseBase: 30,
                ssePerChar: 0.1,
                sseMax: 300,
                ttsBase: 60,
                ttsPerChar: 0.2,
                ttsMax: 600,
                sttBase: 30,
                sttPerChar: 0.05,
                sttMax: 180
            }
        };
    }
    
    getWebSocketUrl() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        return `${protocol}//${host}/ws`;
    }
    
    get(key, defaultValue = null) {
        const keys = key.split('.');
        let value = this.config;
        for (const k of keys) {
            if (value && typeof value === 'object' && k in value) {
                value = value[k];
            } else {
                return defaultValue;
            }
        }
        return value;
    }
    
    set(key, value) {
        const keys = key.split('.');
        let config = this.config;
        for (let i = 0; i < keys.length - 1; i++) {
            const k = keys[i];
            if (!(k in config) || typeof config[k] !== 'object') {
                config[k] = {};
            }
            config = config[k];
        }
        config[keys[keys.length - 1]] = value;
    }
}

// å…¨å±€é…ç½®å®ä¾‹
window.config = new Config();
```

### æ­¥éª¤3ï¼šçŠ¶æ€ç®¡ç†é‡æ„

#### 3.1 å®ç°çŠ¶æ€ç®¡ç†å™¨
```python
# core/state_manager/state_manager.py
from typing import Dict, List, Optional
from enum import Enum

class State(Enum):
    """çŠ¶æ€æšä¸¾"""
    IDLE = 'idle'
    TEXT_SSE = 'text_sse'
    TEXT_TTS = 'text_tts'
    VOICE_STT = 'voice_stt'
    VOICE_SSE = 'voice_sse'
    VOICE_TTS = 'voice_tts'
    VOICE_CALL = 'voice_call'
    ERROR = 'error'

class StateManager:
    """ç»Ÿä¸€çŠ¶æ€ç®¡ç†å™¨"""
    
    def __init__(self):
        self.current_state = State.IDLE
        self.state_history = []
        self.state_locked = False
        self.state_transitions = {
            State.IDLE: [State.TEXT_SSE, State.VOICE_STT, State.VOICE_CALL],
            State.TEXT_SSE: [State.TEXT_TTS, State.IDLE, State.ERROR],
            State.TEXT_TTS: [State.IDLE, State.ERROR],
            State.VOICE_STT: [State.VOICE_SSE, State.IDLE, State.ERROR],
            State.VOICE_SSE: [State.VOICE_TTS, State.IDLE, State.ERROR],
            State.VOICE_TTS: [State.IDLE, State.ERROR],
            State.VOICE_CALL: [State.IDLE, State.ERROR],
            State.ERROR: [State.IDLE]
        }
    
    def set_state(self, new_state: State) -> bool:
        """è®¾ç½®çŠ¶æ€"""
        if self.state_locked:
            return False
        
        if self.can_transition(new_state):
            self.state_history.append(self.current_state)
            self.current_state = new_state
            return True
        return False
    
    def get_state(self) -> State:
        """è·å–å½“å‰çŠ¶æ€"""
        return self.current_state
    
    def can_transition(self, new_state: State) -> bool:
        """æ£€æŸ¥çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•"""
        return new_state in self.state_transitions.get(self.current_state, [])
    
    def lock_state(self) -> None:
        """é”å®šçŠ¶æ€"""
        self.state_locked = True
    
    def unlock_state(self) -> None:
        """è§£é”çŠ¶æ€"""
        self.state_locked = False
    
    def rollback_state(self) -> bool:
        """å›æ»šçŠ¶æ€"""
        if self.state_history:
            previous_state = self.state_history.pop()
            self.current_state = previous_state
            return True
        return False
```

#### 3.2 å®ç°äº‹ä»¶ç®¡ç†å™¨
```python
# core/event_manager/event_manager.py
from typing import Dict, List, Callable, Any
from enum import Enum
import asyncio

class Event(Enum):
    """äº‹ä»¶æšä¸¾"""
    TEXT_START = 'text_start'
    TEXT_SSE_COMPLETE = 'text_sse_complete'
    TEXT_TTS_COMPLETE = 'text_tts_complete'
    VOICE_RECORD_START = 'voice_record_start'
    VOICE_STT_COMPLETE = 'voice_stt_complete'
    VOICE_SSE_COMPLETE = 'voice_sse_complete'
    VOICE_TTS_COMPLETE = 'voice_tts_complete'
    VOICE_CALL_START = 'voice_call_start'
    VOICE_CALL_END = 'voice_call_end'
    ERROR_OCCURRED = 'error_occurred'
    RESET_STATE = 'reset_state'

class EventManager:
    """äº‹ä»¶ç®¡ç†å™¨"""
    
    def __init__(self):
        self.event_handlers = {}
        self.event_queue = []
        self.event_processing = False
    
    def register_handler(self, event_type: Event, handler: Callable) -> None:
        """æ³¨å†Œäº‹ä»¶å¤„ç†å™¨"""
        if event_type not in self.event_handlers:
            self.event_handlers[event_type] = []
        self.event_handlers[event_type].append(handler)
    
    def emit_event(self, event_type: Event, data: Any = None) -> None:
        """è§¦å‘äº‹ä»¶"""
        self.event_queue.append((event_type, data))
        if not self.event_processing:
            asyncio.create_task(self.process_events())
    
    async def process_events(self) -> None:
        """å¤„ç†äº‹ä»¶é˜Ÿåˆ—"""
        self.event_processing = True
        while self.event_queue:
            event_type, data = self.event_queue.pop(0)
            if event_type in self.event_handlers:
                for handler in self.event_handlers[event_type]:
                    try:
                        if asyncio.iscoroutinefunction(handler):
                            await handler(data)
                        else:
                            handler(data)
                    except Exception as e:
                        print(f"äº‹ä»¶å¤„ç†é”™è¯¯: {e}")
        self.event_processing = False
```

### æ­¥éª¤4ï¼šWebSocketè¿æ¥ç®¡ç†ä¼˜åŒ–

#### 4.1 å®ç°WebSocketç®¡ç†å™¨
```python
# core/websocket_manager/websocket_manager.py
import asyncio
import websockets
import json
from typing import Dict, Any, Optional
from config.config import config

class WebSocketManager:
    """WebSocketç®¡ç†å™¨"""
    
    def __init__(self):
        self.connection = None
        self.reconnect_attempts = 0
        self.max_reconnect_attempts = config.get('websocket.reconnect_attempts', 5)
        self.reconnect_interval = config.get('websocket.reconnect_interval', 5000)
        self.heartbeat_interval = config.get('websocket.heartbeat_interval', 30000)
        self.heartbeat_task = None
        self.message_handlers = {}
    
    async def connect(self) -> bool:
        """å»ºç«‹è¿æ¥"""
        try:
            url = config.get('websocket.url')
            self.connection = await websockets.connect(url)
            self.reconnect_attempts = 0
            self.start_heartbeat()
            return True
        except Exception as e:
            print(f"WebSocketè¿æ¥å¤±è´¥: {e}")
            return False
    
    async def disconnect(self) -> None:
        """æ–­å¼€è¿æ¥"""
        if self.connection:
            await self.connection.close()
            self.connection = None
        if self.heartbeat_task:
            self.heartbeat_task.cancel()
    
    async def send_message(self, message: Dict[str, Any]) -> bool:
        """å‘é€æ¶ˆæ¯"""
        if self.connection and not self.connection.closed:
            try:
                await self.connection.send(json.dumps(message))
                return True
            except Exception as e:
                print(f"å‘é€æ¶ˆæ¯å¤±è´¥: {e}")
                return False
        return False
    
    def start_heartbeat(self) -> None:
        """å¼€å§‹å¿ƒè·³æ£€æµ‹"""
        if self.heartbeat_task:
            self.heartbeat_task.cancel()
        self.heartbeat_task = asyncio.create_task(self.heartbeat())
    
    async def heartbeat(self) -> None:
        """å¿ƒè·³æ£€æµ‹"""
        while True:
            try:
                if self.connection and not self.connection.closed:
                    await self.send_message({
                        'type': 'heartbeat',
                        'timestamp': asyncio.get_event_loop().time()
                    })
                await asyncio.sleep(self.heartbeat_interval / 1000)
            except Exception as e:
                print(f"å¿ƒè·³æ£€æµ‹å¤±è´¥: {e}")
                break
    
    async def handle_reconnect(self) -> None:
        """å¤„ç†é‡è¿"""
        if self.reconnect_attempts < self.max_reconnect_attempts:
            self.reconnect_attempts += 1
            delay = self.reconnect_interval * (2 ** (self.reconnect_attempts - 1))
            await asyncio.sleep(delay / 1000)
            await self.connect()
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- çŠ¶æ€ç®¡ç†å™¨æµ‹è¯•
- äº‹ä»¶ç®¡ç†å™¨æµ‹è¯•
- WebSocketç®¡ç†å™¨æµ‹è¯•
- é…ç½®ç®¡ç†å™¨æµ‹è¯•
- é”™è¯¯å¤„ç†å™¨æµ‹è¯•

### é›†æˆæµ‹è¯•
- çŠ¶æ€ç®¡ç†é›†æˆæµ‹è¯•
- äº‹ä»¶å¤„ç†é›†æˆæµ‹è¯•
- WebSocketè¿æ¥é›†æˆæµ‹è¯•
- é…ç½®ç®¡ç†é›†æˆæµ‹è¯•
- é”™è¯¯å¤„ç†é›†æˆæµ‹è¯•

### ç«¯åˆ°ç«¯æµ‹è¯•
- æ–‡æœ¬èŠå¤©åŠŸèƒ½æµ‹è¯•
- å½•éŸ³èŠå¤©åŠŸèƒ½æµ‹è¯•
- è¯­éŸ³é€šè¯åŠŸèƒ½æµ‹è¯•
- é”™è¯¯å¤„ç†æµ‹è¯•
- æ€§èƒ½æµ‹è¯•

## ğŸ“Š é£é™©è¯„ä¼°å’Œåº”å¯¹

### é«˜é£é™©
- **çŠ¶æ€ç®¡ç†é‡æ„**ï¼šå¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½
  - **åº”å¯¹**ï¼šå……åˆ†æµ‹è¯•ã€é€æ­¥æ›¿æ¢ã€å›æ»šæ–¹æ¡ˆ
- **WebSocketé‡æ„**ï¼šå¯èƒ½å½±å“è¯­éŸ³åŠŸèƒ½
  - **åº”å¯¹**ï¼šä¿æŒå…¼å®¹æ€§ã€è‡ªåŠ¨é‡è¿ã€é”™è¯¯å¤„ç†
- **äº‹ä»¶å¤„ç†é‡æ„**ï¼šå¯èƒ½å½±å“ç”¨æˆ·äº¤äº’
  - **åº”å¯¹**ï¼šäº‹ä»¶ä¼˜å…ˆçº§ã€å†²çªå¤„ç†ã€ç”¨æˆ·åé¦ˆ

### ä¸­é£é™©
- **é…ç½®ç®¡ç†é‡æ„**ï¼šå¯èƒ½å½±å“éƒ¨ç½²
  - **åº”å¯¹**ï¼šé…ç½®éªŒè¯ã€ç¯å¢ƒæ£€æŸ¥ã€éƒ¨ç½²æµ‹è¯•
- **é”™è¯¯å¤„ç†é‡æ„**ï¼šå¯èƒ½å½±å“é”™è¯¯æç¤º
  - **åº”å¯¹**ï¼šé”™è¯¯åˆ†ç±»ã€ç”¨æˆ·å‹å¥½æç¤ºã€æ—¥å¿—è®°å½•

### ä½é£é™©
- **ä»£ç ç»“æ„ä¼˜åŒ–**ï¼šå½±å“è¾ƒå°
  - **åº”å¯¹**ï¼šä»£ç å®¡æŸ¥ã€æµ‹è¯•éªŒè¯
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå½±å“è¾ƒå°
  - **åº”å¯¹**ï¼šæ€§èƒ½æµ‹è¯•ã€ç›‘æ§æŒ‡æ ‡

## ğŸ¯ æˆåŠŸæ ‡å‡†

### åŠŸèƒ½æ ‡å‡†
- [ ] æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] çŠ¶æ€ç®¡ç†ç¨³å®šå¯é 
- [ ] WebSocketè¿æ¥ç¨³å®š
- [ ] äº‹ä»¶å¤„ç†æ— å†²çª
- [ ] é”™è¯¯å¤„ç†ç”¨æˆ·å‹å¥½

### æ€§èƒ½æ ‡å‡†
- [ ] å“åº”æ—¶é—´ < 2ç§’
- [ ] å†…å­˜ä½¿ç”¨ < 500MB
- [ ] CPUä½¿ç”¨ < 50%
- [ ] é”™è¯¯ç‡ < 1%

### è´¨é‡æ ‡å‡†
- [ ] ä»£ç è¦†ç›–ç‡ > 80%
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡ç‡ 100%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ç‡ 100%
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡ç‡ 100%

---

**æ€»ç»“**ï¼šæœ¬å®æ–½è®¡åˆ’é€šè¿‡åˆ†é˜¶æ®µã€åˆ†æ¨¡å—çš„æ–¹å¼ï¼Œç¡®ä¿é‡æ„è¿‡ç¨‹çš„ç¨³å®šæ€§å’Œå¯æ§æ€§ã€‚æ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ˜ç¡®çš„ç›®æ ‡ã€ä»»åŠ¡æ¸…å•å’Œäº¤ä»˜ç‰©ï¼ŒåŒæ—¶åŒ…å«è¯¦ç»†çš„æµ‹è¯•ç­–ç•¥å’Œé£é™©è¯„ä¼°ï¼Œç¡®ä¿é‡æ„æˆåŠŸã€‚
