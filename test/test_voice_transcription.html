<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³è½¬æ–‡æœ¬æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .record-btn { background-color: #007bff; color: white; }
        .stop-btn { background-color: #dc3545; color: white; }
        .test-btn { background-color: #28a745; color: white; }
        #test-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #log {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>è¯­éŸ³è½¬æ–‡æœ¬åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>1. è¾“å…¥æ¡†æµ‹è¯•</h3>
        <input type="text" id="ai-chat-x-input" placeholder="è¿™é‡Œåº”è¯¥æ˜¾ç¤ºè½¬å½•çš„æ–‡æœ¬" class="test-input">
        <button onclick="testInputBox()" class="test-btn">æµ‹è¯•è¾“å…¥æ¡†</button>
        <div id="input-test-status"></div>
    </div>
    
    <div class="test-section">
        <h3>2. WebSocketè¿æ¥æµ‹è¯•</h3>
        <button onclick="testWebSocket()" class="test-btn">æµ‹è¯•WebSocketè¿æ¥</button>
        <div id="websocket-status"></div>
    </div>
    
    <div class="test-section">
        <h3>3. è¯­éŸ³å½•åˆ¶æµ‹è¯•</h3>
        <button id="record-btn" onclick="toggleRecording()" class="record-btn">å¼€å§‹å½•éŸ³</button>
        <div id="recording-status"></div>
        <div id="waveform-container" style="display: none; height: 50px; background: #f0f0f0; margin: 10px 0;"></div>
    </div>
    
    <div class="test-section">
        <h3>4. æ—¥å¿—è¾“å‡º</h3>
        <div id="log"></div>
        <button onclick="clearLog()" class="test-btn">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let websocket = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function testInputBox() {
            const input = document.getElementById('ai-chat-x-input');
            const status = document.getElementById('input-test-status');
            
            if (input) {
                input.value = 'æµ‹è¯•æ–‡æœ¬ - ' + new Date().toLocaleTimeString();
                status.innerHTML = '<div class="status success">âœ“ è¾“å…¥æ¡†æµ‹è¯•æˆåŠŸ</div>';
                log('è¾“å…¥æ¡†æµ‹è¯•æˆåŠŸ');
            } else {
                status.innerHTML = '<div class="status error">âœ— æœªæ‰¾åˆ°è¾“å…¥æ¡†</div>';
                log('æœªæ‰¾åˆ°è¾“å…¥æ¡†');
            }
        }
        
        function testWebSocket() {
            const statusDiv = document.getElementById('websocket-status');
            statusDiv.innerHTML = '<div class="status warning">æ­£åœ¨æµ‹è¯•WebSocketè¿æ¥...</div>';
            log('å¼€å§‹æµ‹è¯•WebSocketè¿æ¥');
            
            try {
                const ws = new WebSocket('ws://192.168.32.156:9800/ws/chat');
                
                ws.onopen = function() {
                    statusDiv.innerHTML = '<div class="status success">âœ“ WebSocketè¿æ¥æˆåŠŸ</div>';
                    log('WebSocketè¿æ¥æˆåŠŸ');
                    ws.close();
                };
                
                ws.onerror = function(error) {
                    statusDiv.innerHTML = '<div class="status error">âœ— WebSocketè¿æ¥å¤±è´¥</div>';
                    log('WebSocketè¿æ¥å¤±è´¥: ' + error);
                };
                
                ws.onclose = function() {
                    log('WebSocketè¿æ¥å·²å…³é—­');
                };
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">âœ— WebSocketè¿æ¥å¼‚å¸¸</div>';
                log('WebSocketè¿æ¥å¼‚å¸¸: ' + error);
            }
        }
        
        async function toggleRecording() {
            const btn = document.getElementById('record-btn');
            const status = document.getElementById('recording-status');
            const waveform = document.getElementById('waveform-container');
            
            if (!isRecording) {
                // å¼€å§‹å½•éŸ³
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        processRecording();
                    };
                    
                    mediaRecorder.start(100);
                    isRecording = true;
                    
                    btn.textContent = 'åœæ­¢å½•éŸ³';
                    btn.className = 'stop-btn';
                    status.innerHTML = '<div class="status warning">æ­£åœ¨å½•éŸ³...</div>';
                    waveform.style.display = 'block';
                    waveform.innerHTML = '<div style="text-align: center; line-height: 50px;">ğŸ¤ å½•éŸ³ä¸­...</div>';
                    
                    log('å¼€å§‹å½•éŸ³');
                    
                } catch (error) {
                    status.innerHTML = '<div class="status error">âœ— æ— æ³•è®¿é—®éº¦å…‹é£</div>';
                    log('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error);
                }
            } else {
                // åœæ­¢å½•éŸ³
                if (mediaRecorder) {
                    mediaRecorder.stop();
                    isRecording = false;
                    
                    btn.textContent = 'å¼€å§‹å½•éŸ³';
                    btn.className = 'record-btn';
                    status.innerHTML = '<div class="status warning">æ­£åœ¨å¤„ç†å½•éŸ³...</div>';
                    waveform.style.display = 'none';
                    
                    log('åœæ­¢å½•éŸ³');
                }
            }
        }
        
        async function processRecording() {
            const status = document.getElementById('recording-status');
            
            try {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                log('å½•éŸ³å¤„ç†å®Œæˆï¼ŒéŸ³é¢‘å¤§å°: ' + audioBlob.size + ' å­—èŠ‚');
                
                // æ¨¡æ‹Ÿè¯­éŸ³è½¬æ–‡æœ¬
                status.innerHTML = '<div class="status warning">æ­£åœ¨è½¬æ¢è¯­éŸ³...</div>';
                
                // è¿™é‡Œåº”è¯¥å‘é€åˆ°åç«¯è¿›è¡Œè¯­éŸ³è½¬æ–‡æœ¬
                // ç°åœ¨å…ˆæ¨¡æ‹Ÿä¸€ä¸ªç»“æœ
                setTimeout(() => {
                    const testText = 'è¿™æ˜¯æµ‹è¯•è½¬å½•ç»“æœ - ' + new Date().toLocaleTimeString();
                    const input = document.getElementById('ai-chat-x-input');
                    
                    if (input) {
                        input.value = testText;
                        input.focus();
                        status.innerHTML = '<div class="status success">âœ“ è¯­éŸ³è½¬æ–‡æœ¬å®Œæˆ</div>';
                        log('è¯­éŸ³è½¬æ–‡æœ¬å®Œæˆ: ' + testText);
                    } else {
                        status.innerHTML = '<div class="status error">âœ— æœªæ‰¾åˆ°è¾“å…¥æ¡†</div>';
                        log('æœªæ‰¾åˆ°è¾“å…¥æ¡†');
                    }
                }, 2000);
                
            } catch (error) {
                status.innerHTML = '<div class="status error">âœ— å¤„ç†å½•éŸ³å¤±è´¥</div>';
                log('å¤„ç†å½•éŸ³å¤±è´¥: ' + error);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('è¯­éŸ³è½¬æ–‡æœ¬æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('WebSocketåœ°å€: ws://192.168.32.156:9800/ws/chat');
        });
    </script>
</body>
</html>
