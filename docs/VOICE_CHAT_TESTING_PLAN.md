# 实时语音对话功能测试计划

**项目**: YYAssistant 实时语音对话功能测试  
**版本**: v1.0  
**日期**: 2025年1月  
**测试范围**: 文本聊天、录音对话、语音实时对话三个场景

---

## 📋 测试概述

### 测试目标
验证实时语音对话系统的三个核心场景功能：
1. **文本聊天场景** - 文本输入、SSE流式响应、TTS播放
2. **录音对话场景** - 语音录制、STT转换、AI处理、TTS播放
3. **语音实时对话场景** - 实时音频流、VAD检测、连续对话

### 测试环境
- **前端**: http://192.168.66.209:8050/core/chat
- **后端**: http://192.168.66.209:9800
- **浏览器**: Chrome/Firefox/Safari (支持WebRTC)
- **设备**: 需要麦克风和扬声器

---

## 🎯 测试场景详细规划

### 场景1: 文本聊天功能测试

#### 1.1 基础文本输入测试
**测试步骤**:
1. 打开聊天页面 `/core/chat`
2. 在输入框中输入文本："你好，请介绍一下自己"
3. 点击发送按钮
4. 观察按钮状态变化
5. 等待SSE响应完成
6. 观察TTS播放

**预期结果**:
- ✅ 输入框正常显示文本
- ✅ 发送按钮状态变为loading
- ✅ 录音和通话按钮变为disabled
- ✅ SSE流式输出文本内容
- ✅ TTS自动播放回复内容
- ✅ 所有按钮状态回到idle

#### 1.2 长文本处理测试
**测试步骤**:
1. 输入长文本（>500字符）
2. 发送并观察处理过程
3. 检查TTS分段播放

**预期结果**:
- ✅ 长文本正常处理
- ✅ TTS智能分段播放
- ✅ 按钮状态正确管理

#### 1.3 空输入验证测试
**测试步骤**:
1. 不输入任何内容直接点击发送
2. 观察系统响应

**预期结果**:
- ✅ 显示警告提示
- ✅ 按钮状态不改变
- ✅ 不触发SSE请求

### 场景2: 录音对话功能测试

#### 2.1 基础录音功能测试
**测试步骤**:
1. 点击录音按钮开始录音
2. 说话："请告诉我今天的天气"
3. 松开录音按钮停止录音
4. 观察处理流程

**预期结果**:
- ✅ 录音按钮状态变为recording
- ✅ 显示录音波形动画
- ✅ 文本和通话按钮变为disabled
- ✅ 录音完成后自动STT转换
- ✅ STT结果填入输入框
- ✅ 自动触发SSE处理
- ✅ TTS播放回复

#### 2.2 录音权限测试
**测试步骤**:
1. 拒绝麦克风权限
2. 尝试录音
3. 观察错误处理

**预期结果**:
- ✅ 显示权限错误提示
- ✅ 按钮状态正确恢复
- ✅ 提供权限设置指导

#### 2.3 录音质量测试
**测试步骤**:
1. 在嘈杂环境中录音
2. 轻声说话录音
3. 快速连续录音

**预期结果**:
- ✅ 嘈杂环境正常处理
- ✅ 轻声说话能识别
- ✅ 连续录音不冲突

### 场景3: 语音实时对话功能测试

#### 3.1 实时对话启动测试
**测试步骤**:
1. 点击"开始实时对话"按钮
2. 观察UI状态变化
3. 开始说话测试VAD检测

**预期结果**:
- ✅ 按钮状态变为listening
- ✅ 显示实时状态指示器
- ✅ 音频可视化开始工作
- ✅ VAD正确检测语音活动

#### 3.2 连续对话测试
**测试步骤**:
1. 启动实时对话
2. 进行多轮对话
3. 测试对话历史记录

**预期结果**:
- ✅ 连续对话流畅进行
- ✅ 对话历史正确记录
- ✅ 状态指示器实时更新

#### 3.3 实时对话控制测试
**测试步骤**:
1. 测试静音/取消静音
2. 测试停止对话
3. 测试音量调节

**预期结果**:
- ✅ 静音功能正常工作
- ✅ 停止对话正确退出
- ✅ 音量调节生效

---

## 🔧 按钮状态测试矩阵

### 状态转换测试表

| 当前状态 | 触发动作 | 预期状态 | 按钮状态 |
|---------|---------|---------|---------|
| IDLE | 点击发送 | TEXT_PROCESSING | 发送:loading+disabled, 录音:disabled, 通话:disabled |
| IDLE | 点击录音 | RECORDING | 发送:disabled, 录音:active, 通话:disabled |
| IDLE | 点击通话 | CALLING | 发送:disabled, 录音:disabled, 通话:active |
| TEXT_PROCESSING | TTS完成 | IDLE | 所有按钮:enabled |
| RECORDING | 停止录音 | VOICE_PROCESSING | 发送:loading+disabled, 录音:processing, 通话:disabled |
| VOICE_PROCESSING | TTS完成 | IDLE | 所有按钮:enabled |
| CALLING | 停止通话 | IDLE | 所有按钮:enabled |

### 状态并发测试
**测试步骤**:
1. 快速连续点击不同按钮
2. 在TTS播放时点击其他按钮
3. 在SSE处理时尝试录音

**预期结果**:
- ✅ 状态转换正确排队
- ✅ 并发操作被正确阻止
- ✅ 状态一致性保持

---

## 🤖 自动化测试需求分析

### 如果实施自动化测试，需要以下权限和能力：

#### 1. 浏览器自动化权限
```javascript
// 需要的能力
- 控制浏览器窗口和标签页
- 模拟用户点击、输入、滚动
- 访问DOM元素和属性
- 执行JavaScript代码
- 截图和录屏功能
```

#### 2. 音频设备访问权限
```javascript
// 需要的能力
- 访问系统麦克风设备
- 模拟音频输入（测试音频文件播放）
- 控制音频输出设备
- 录制音频输出进行验证
```

#### 3. 网络和API权限
```javascript
// 需要的能力
- 拦截和修改HTTP请求
- 模拟网络延迟和错误
- 访问WebSocket连接状态
- 监控网络流量
```

#### 4. 系统级权限
```javascript
// 需要的能力
- 访问浏览器开发者工具
- 读取浏览器控制台日志
- 访问浏览器存储（localStorage, sessionStorage）
- 控制浏览器权限设置
```

### 自动化测试工具推荐

#### 1. Playwright (推荐)
```bash
# 安装
npm install @playwright/test

# 优势
- 支持多浏览器（Chrome, Firefox, Safari）
- 内置音频/视频录制
- 强大的网络拦截能力
- 支持移动端测试
```

#### 2. Puppeteer + Chrome DevTools
```bash
# 安装
npm install puppeteer

# 优势
- 深度Chrome集成
- 强大的DevTools API
- 音频设备控制
- 网络请求拦截
```

#### 3. Selenium + WebDriver
```bash
# 安装
pip install selenium

# 优势
- 跨平台支持
- 多语言绑定
- 广泛的浏览器支持
```

### 自动化测试实施建议

#### 阶段1: 基础功能自动化
```javascript
// 测试用例示例
describe('文本聊天功能', () => {
  test('发送文本消息', async () => {
    await page.goto('/core/chat');
    await page.fill('#ai-chat-x-input', '你好');
    await page.click('#ai-chat-x-send-btn');
    await expect(page.locator('#ai-chat-x-send-btn')).toHaveAttribute('loading', 'true');
    await page.waitForSelector('.message-content');
  });
});
```

#### 阶段2: 音频功能自动化
```javascript
// 需要特殊配置
const context = await browser.newContext({
  permissions: ['microphone', 'camera'],
  audio: true,
  video: true
});
```

#### 阶段3: 性能测试自动化
```javascript
// 性能监控
await page.evaluate(() => {
  return performance.getEntriesByType('navigation');
});
```

---

## 📊 测试执行计划

### 手动测试阶段 (1-2天)
1. **Day 1**: 基础功能测试
   - 文本聊天场景完整测试
   - 录音对话场景完整测试
   - 按钮状态转换验证

2. **Day 2**: 高级功能测试
   - 语音实时对话场景测试
   - 错误处理和边界情况测试
   - 性能和质量测试

### 自动化测试阶段 (3-5天)
1. **Day 3-4**: 自动化测试开发
   - 设置测试环境和工具
   - 编写基础功能测试用例
   - 配置音频设备模拟

2. **Day 5**: 自动化测试执行
   - 运行完整测试套件
   - 生成测试报告
   - 性能基准测试

---

## 📈 测试成功标准

### 功能标准
- ✅ 三个场景功能100%可用
- ✅ 按钮状态转换100%正确
- ✅ 错误处理覆盖率>90%
- ✅ 用户体验流畅度>95%

### 性能标准
- ✅ 文本响应时间<3秒
- ✅ 录音处理时间<5秒
- ✅ 实时对话延迟<2秒
- ✅ 音频质量清晰度>90%

### 稳定性标准
- ✅ 连续使用1小时无崩溃
- ✅ 并发用户数>10
- ✅ 错误恢复时间<5秒
- ✅ 内存使用稳定

---

## 🚨 风险控制

### 测试风险
- **音频设备不可用**: 准备备用测试方案
- **网络不稳定**: 配置网络模拟环境
- **浏览器兼容性**: 多浏览器并行测试
- **性能瓶颈**: 准备性能监控工具

### 缓解措施
- 建立测试环境备份
- 准备多种测试方案
- 实施渐进式测试策略
- 建立问题快速响应机制

---

**测试负责人**: 开发团队  
**预计完成时间**: 5天  
**资源需求**: 1名测试人员，1名开发支持
